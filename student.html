<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>児童チャット</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{
      font-family:system-ui; margin:0;
      background:#f5f7fa;
      display:flex; justify-content:center;
      padding:20px;
    }
    .box{
      width:100%; max-width:750px;
      background:white; border-radius:10px;
      padding:20px; box-shadow:0 4px 16px rgba(0,0,0,0.1);
    }
    #chat{ height:420px; overflow-y:auto; border:1px solid #ddd; padding:10px; }
    .msg{ margin-bottom:12px; }
    .me{ color:#0b6efd; }
    .ai{ color:#333; background:#eef4ff; padding:8px; border-radius:6px; }
    #inputArea{ margin-top:10px; display:flex; gap:8px; }
    #inputArea input{ flex:1; padding:10px; }
    #inputArea button{ padding:10px 14px; background:#0b6efd; color:white; border:none; }
  </style>
</head>
<body>
  <div class="box">
    <h2>児童チャット</h2>

    <div id="problemArea" style="padding:10px; background:#f0f0f0; margin-bottom:10px;">
      問題読み込み中…
    </div>

    <div id="chat"></div>

    <div id="inputArea">
      <input id="msgInput" type="text" placeholder="説明を入力" />
      <button id="sendBtn">送信</button>
    </div>
  </div>
<script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const problemArea = document.getElementById("problemArea");

    let problemText = "";
    let answerText = ""; // ★ 解答も保持（先生のヒントとして利用可能）

    /**
     * URLからクエリパラメータ（ID）を取得する関数
     */
    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }
    
    // --- 問題の取得 ---
    async function loadProblem(){
        const questionId = getQueryParam('id'); // URLからIDを取得
        
        if (!questionId) {
            problemText = "(問題が指定されていません)";
            problemArea.textContent = problemText;
            return;
        }

        try {
            // 新しく作成した問題詳細APIを呼び出す
            const res = await fetch(`/api/question_detail/${questionId}`); // ★ サーバーAPIのURLを使用
            
            if (!res.ok) {
                problemText = `(問題データの取得に失敗しました: ${res.status})`;
                problemArea.textContent = problemText;
                return;
            }
            
            const data = await res.json();
            
            // データを変数に格納
            problemText = data.question_title + " - " + data.question; 
            answerText = data.answer; 

            // 問題エリアに表示
            problemArea.innerHTML = `
                <div style="font-weight:bold; margin-bottom:5px;">${data.question_title}</div>
                <div>${data.question}</div>
            `;

            // AI に自動で「最初の質問」を送らせる
            if(problemText.trim() !== ""){
                chat.innerHTML += `<div class="msg ai">児童: 先生、この問題なんですが…ちょっとよくわからないから教えてください！</div>`;
            }

        } catch (error) {
            console.error("問題読み込みエラー:", error);
            problemArea.textContent = "問題読み込み中にエラーが発生しました。";
        }
    }

    loadProblem();


    // --- チャット送信 ---
    async function sendMessage(){
        const text = input.value.trim();
        if(!text) return;

        chat.innerHTML += `<div class="msg me">先生: ${text}</div>`;
        chat.scrollTop = chat.scrollHeight;

        input.value = "";
        sendBtn.disabled = true;

        // FastAPIサーバー（main.py）のAPIを呼び出す
        // ★ サーバーのポートが 8000 (FastAPI) と 3000 (Node.js) で異なるため、
        //    FastAPIのURLを明示的に指定します。
        const res = await fetch("http://localhost:8000/api/ai_response", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ 
                // 問題文と解答をAIにコンテキストとして送る
                message: text,
                // 問題文と解答をコンテキストとして追加（main.pyの仕様に依存）
                context_problem: problemText,
                context_answer: answerText 
            })
        });

        // ... (後略。AI応答の処理はそのまま)
        // ...
    }

    sendBtn.onclick = sendMessage;
    input.onkeydown = (e)=>{ if(e.key==="Enter") sendMessage(); };
  </script>
</body>
</html>
