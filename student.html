<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>児童チャット</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{
    display:flex;
    gap:20px;
    background:#eef5ff;
    font-family:sans-serif;
    padding:20px;
  }

  /* 左のアバター */
  .avatar{
    width:220px;
    background:#fff;
    border-radius:20px;
    padding:20px;
    box-shadow:0 4px 10px rgba(0,0,0,0.15);
    text-align:center;
    height: fit-content;
  }

  .face{
    width:140px; height:140px;
    background:#ffe2c8;
    border-radius:50%;
    margin:0 auto;
    position:relative;
    overflow:hidden;
  }
  .eye{ width:20px; height:20px; background:#000; border-radius:50%;
    position:absolute; top:55px; }
  .eye.left{ left:35px; }
  .eye.right{ right:35px; }
  .blink{ animation:blink 3s infinite; }
  @keyframes blink{
    0%,92%{ transform:scaleY(1); }
    95%,100%{ transform:scaleY(0.1); }
  }

  .mouth{
    width:40px; height:10px;
    border-bottom:4px solid #d9534f;
    border-radius:0 0 20px 20px;
    position:absolute; top:95px; left:50%;
    transform:translateX(-50%); transform-origin:top;
  }

  .talk{
    animation:talk 1s infinite;
  }

  @keyframes talk{
    0%,100%{ height:10px; }
    50%{ height:25px; }
  }

  .cheek{
    width:25px; height:25px; background:#ffb3b3;
    border-radius:50%; position:absolute; top:85px;
  }
  .cheek.left{ left:25px; }
  .cheek.right{ right:25px; }

  .hair{
    width:160px; height:70px; background:#3c2f2f;
    border-radius:80px 80px 20px 20px;
    position:absolute; top:-10px; left:50%;
    transform:translateX(-50%);
  }

  /* チャットエリア */
  .chatBox{
    flex:1;
    max-width:700px;
    background:white;
    border-radius:10px;
    padding:20px;
    box-shadow:0 4px 16px rgba(0,0,0,0.1);
  }

  #chat{ height:420px; overflow-y:auto; border:1px solid #ddd; padding:10px; }
  .msg{ margin-bottom:12px; }
  .me{ color:#0b6efd; }
  .ai{ background:#eef4ff; padding:8px; border-radius:6px; }

</style>
</head>
<body>

<!-- 左側：アバター -->
<div class="avatar">
  <h3>児童アバター</h3>
  <div class="face">
    <div class="hair"></div>
    <div class="eye left blink"></div>
    <div class="eye right blink"></div>
    <div class="cheek left"></div>
    <div class="cheek right"></div>
    <div class="mouth"></div>
  </div>
</div>

<!-- 右側：チャット画面 -->
<div class="chatBox">
  <h2>児童チャット</h2>
  <div id="problemArea" style="padding:10px;background:#f0f0f0;margin-bottom:10px;">
    読み込み中...
  </div>

  <div id="chat"></div>

  <div style="margin-top:10px; display:flex; gap:8px;">
    <input id="msgInput" type="text" style="flex:1; padding:10px;" placeholder="おしえてあげる内容を入力">
    <button id="sendBtn" style="padding:10px 14px; background:#0b6efd; color:white;">送信</button>
  </div>
</div>

<script>
/* ============================
   表情切り替え
============================ */
function setExpression(type) {
  const mouth = document.querySelector('.mouth');
  const cheeks = document.querySelectorAll('.cheek');

  // リセット
  mouth.style = "";
  cheeks.forEach(c => c.style.background = "#ffb3b3");

  if(type === "smile"){
    mouth.style.height = "25px";
  }
  if(type === "sad"){
    mouth.style.border = "none";
    mouth.style.borderTop = "4px solid #d9534f";
    mouth.style.height = "20px";
    mouth.style.borderRadius = "20px 20px 0 0";
  }
  if(type === "angry"){
    cheeks.forEach(c => c.style.background = "#ff8888");
    mouth.style.borderBottom = "4px solid #b22";
  }
  if(type === "surprise"){
    mouth.style.border = "4px solid #d9534f";
    mouth.style.width = "25px";
    mouth.style.height = "25px";
    mouth.style.borderRadius = "50%";
  }
}

/* ============================
   表情の自動判定ロジック
============================ */
function detectEmotion(text){
  text = text.toLowerCase();

  if(text.includes("すごい") || text.includes("できた") || text.includes("ありがとう"))
    return "smile";

  if(text.includes("わからない") || text.includes("むずかしい"))
    return "sad";

  if(text.includes("ちがう") || text.includes("なんで"))
    return "angry";

  if(text.includes("えっ") || text.includes("ほんと"))
    return "surprise";

  return "smile";
}

/* ============================
   チャット処理
============================ */
const chat = document.getElementById("chat");
const input = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const problemArea = document.getElementById("problemArea");

let problemText = "";

// ★ 問題読込
async function loadProblem(){
  const res = await fetch("http://127.0.0.1:8000/api/get_problem");
  const data = await res.json();
  problemText = data.problem;
  problemArea.textContent = "今日の問題: " + problemText;

  chat.innerHTML += `<div class="msg ai">児童: 先生、この問題ちょっとむずかしいかも…</div>`;
  setExpression("sad");
}
loadProblem();

// ★ メッセージ送信
async function sendMessage(){
  const text = input.value.trim();
  if(!text) return;

  chat.innerHTML += `<div class="msg me">先生: ${text}</div>`;
  chat.scrollTop = chat.scrollHeight;
  input.value = "";

  const res = await fetch("http://127.0.0.1:8000/api/ai_response", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ message:text })
  });

  const data = await res.json();
  const aiText = data.response;

  // AI返答を1回だけ表示
  chat.innerHTML += `<div class="msg ai">児童: ${aiText}</div>`;
  chat.scrollTop = chat.scrollHeight;

  // ★ 表情判定
  const emo = detectEmotion(aiText);
  setExpression(emo);
}

sendBtn.onclick = sendMessage;
input.onkeydown = e => { if(e.key==="Enter") sendMessage(); };
</script>

</body>
</html>
